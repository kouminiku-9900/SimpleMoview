# 【Macアプリ開発】フォルダ丸ごと再生！「SimpleMoview」を作った話 (Draft)

## はじめに
Macで動画を見るとき、機能過多なプレイヤーやライブラリ管理型のアプリに疲れを感じたことはありませんか？
「ただ、このフォルダにある動画を順番に（あるいはランダムに）流し見したいだけなのに……」
そんな思いから、**SimpleMoview** というシンプルな動画プレイヤーアプリを開発しました。

今回は、このアプリを開発した経緯や、採用した技術、実装時のこだわりポイントについてまとめました。

---

## 1. なぜ作ろうと思ったのか？

既存の動画プレイヤーには素晴らしいものがたくさんありますが、私のユースケースには少し合わない部分がありました。

*   **ライブラリ登録が面倒**: "Music"アプリや一部のプレイヤーは、ファイルを再生するために一度ライブラリに取り込む必要があります。「ダウンロードしたフォルダをそのまま再生したい」というニーズには少し重すぎました。
*   **操作性がマウス寄り**: 再生・停止・スキップなどはキーボードだけでサクサク行いたい。特にエンジニアなら馴染み深い **YouTubeライクな操作 (j/k/l)** で動画をコントロールしたかったのです。
*   **ラジオや音楽の流し聴き**: 録音した長時間のラジオ番組や、CDからリッピングしたFLAC形式のアルバムなど、「フォルダごとにまとまった音声ファイル」をBGMとして流し続けたい時があります。動画に限らず、こうしたオーディオファイルを「ながら再生」するのにちょうどいいアプリが欲しかったのです。
*   **シンプルさ**: プレイリスト画面もメタデータ編集もいらない。ただファイルを開いて再生する、それだけの軽量なアプリが欲しかったのです。

そこで、「フォルダを指定したら、中身を自動でプレイリスト化して再生してくれる」超シンプルなアプリを自作することにしました。

## 2. 採用した技術とその理由

### 技術スタック
*   **言語**: Swift
*   **フレームワーク**: SwiftUI, AppKit (一部), AVKit, Combine

### 選定理由
1.  **SwiftUI**:
    *   MacアプリらしいモダンなUIを爆速で構築するため。`VideoPlayer` コンポーネントを使えば、数行で動画再生プレイヤーが埋め込めます。
    *   ステート管理（再生状態、シャッフル状態など）に `@StateObject` や `@Published` を使うことで、ViewとLogicを綺麗に分離できるのも魅力です。

2.  **AVKit (AVPlayer)**:
    *   Apple純正のメディア再生フレームワーク。パフォーマンスが最適化されており、主要なフォーマット（mp4, mov, m4vなど）に標準対応しているため。自前でデコーダーを実装する必要がなく、信頼性が高いです。

3.  **Combine**:
    *   動画の「再生終了通知 (`.AVPlayerItemDidPlayToEndTime`)」を受け取り、自動で次の動画へ遷移する処理をスマートに書くために採用しました。

## 3. プログラミングにおける工夫と解決策

開発中に直面した課題と、それをどう解決したかの考察です。

### 課題1: キーボード操作の奪い合い
SwiftUI標準の `.keyboardShortcut` modifierだけでは、フォーカスが外れたり、特定のキー（例えばSpaceキーや矢印キー）の挙動がOS標準の挙動と競合したりすることがありました。また、YouTubeライクな `j` (10秒戻る) / `k` (一時停止) / `l` (10秒進む) / `n` (次へ) / `p` (前へ) といった独自ショートカットを確実に効かせたいという要望がありました。

**解決策: `NSEvent.addLocalMonitorForEvents` の活用**
SwiftUIのレイヤーだけで頑張るのではなく、少し下のレイヤーである `AppKit` の `NSEvent` を監視する方法を採用しました。
これにより、ウィンドウがアクティブであれば確実にキー入力をフックでき、「1〜9キーで10%〜90%の位置へジャンプ」といった柔軟なショートカットも簡単に実装できました。

```swift
// 実装イメージ
NSEvent.addLocalMonitorForEvents(matching: .keyDown) { event in
    switch event.characters {
    case "l": self.step(by: 10) // 10秒進む
    case "k": self.togglePlayPause() // 再生/停止
    // ...
    }
    return nil // イベントを消費
}
```

### 課題2: サンドボックス環境でのファイルアクセス
Mac App Storeでの配布やセキュリティを考慮してサンドボックスを有効にしていますが、ユーザーが選択したフォルダ内のファイルにアクセスするには権限管理が必要です。

**解決策: Security-Scoped Resource**
`fileImporter` で取得したURLに対して、`startAccessingSecurityScopedResource()` を適切に呼び出すことで解決しました。これを行わないと、フォルダのパスは分かっても「アクセス権限がない」として読み込みに失敗してしまいます。忘れがちなポイントですが、Macアプリ開発では必須の作法です。

---

## おわりに
**SimpleMoview** は、その名の通り機能はミニマムですが、「キーボードだけで動画をサクサク消化する」という体験においては、既存のプレイヤーよりも快適なツールになったと自負しています。

「欲しい物がなければ自分で作る」。
これを手軽に実現できるのが、個人開発の醍醐味ですね。
